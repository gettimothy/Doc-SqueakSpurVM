# Table of Contents1.  [SqueakSpurVM](#org9725d44)    1.  [Introduction](#org70aeafc)    2.  [Growing Image To 76Gb Email From Eliot Miranda](#orgf4f7da2)    3.  [SmalltalkImage curent  vmParameterAtPut](#orgf2fd084)    4.  [Doits for VMParameters](#org668a48a)    5.  [Rebuild the VM](#org089e6f9)<a id="org9725d44"></a># SqueakSpurVM<a id="org70aeafc"></a>## Introduction    working notes as I set Spur VM parameters.    Hopefully others contribute who know what they are doing.            We start with some relevant classes and methods <a id="orgf4f7da2"></a>## Growing Image To 76Gb Email From Eliot MirandaHere is an email exchange that provides some pointers for making a huge image size.     Hi Timothy,         On Oct 17, 2021, at 8:41 AM, gettimothy via Squeak-dev <squeak-dev@lists.squeakfoundation.org> wrote:         ﻿     Hi Folks,             I am thinking about the result of parsing that 73Gb xml file and storing many of its elements in squeak as live objects.         Assuming an ~1:1 relationship betwen that file and the resultant image, can Squeak handle that?         Can I tell squeak to "SmalltalkImage getLarge:73Gb"  ?              I think It would be a fun experiment if this possible.         thx in advance.         In theory there should be no problem other than a rather sedate snapshot and start up time.         If your machine has enough ram and disc Spur will save and restore that size of image.           You may find that increasing the size of new space/eden to 128/256/512mb, increasing the old space segment size to 1gb, and especially changing the growth to size GC ratio, decreases build time substantially.         About Squeak is your friend.           Under vm parameters you’ll find info on sizes and rooting around you’ll find the levers for setting these sizes through vmParameterAt:put:.       See parameters 25, 45, & 55.      #25 is badly described.  It is actually the minimum old space segment size.  Setting this to eg 1gb means a lot less segments to traverse than the default 16mb.         I’d be interested to see the vm stats at the end of a build. Those will help you tune and find out how much time is being spent in GC.         _,,,^..^,,,_ (phone)<a id="orgf2fd084"></a>## SmalltalkImage curent  vmParameterAtPutThis contains some definitions.    "parameterIndex is a positive integer corresponding to one of the VM's internal    parameter/metric registers.  Store newValue (a positive integer) into that    register and answer with the previous value that was stored there.    Fail if newValue is out of range, if parameterIndex has no corresponding    register, or if the corresponding register is read-only.        As of late 2020 the parameters which can be set are    	5	allocations between GCs (read-write; nil in Cog VMs)    	6	survivor count tenuring threshold (read-write)    	11	tenures of surving objects since startup/last write (read-write)    	12	event trace mask; if 1 << eventType is set in the mask then event received by primGetNextEvent: will be printed to stderr.    	17	proportion of code zone available for use (Sista VMs only)    	23	bytes of extra memory to reserve for VM buffers, plugins, etc.    	24	memory threshold above whichto shrink object memory (read-write)    	25	memory headroom when growing object memory (read-write)    	26	interruptChecksEveryNms - force an ioProcessEvents every N milliseconds (read-write)    	34	bytes allocated in total since start-up or reset (read-write)    	43	desired number of stack pages (stored in image file header, max 65535; Cog VMs only, otherwise nil)    	45	desired size of eden, in bytes (stored in image file header; Cog VMs only, otherwise nil)    	47	desired size of machine code zone, in bytes (applies at startup only, stored in image file header; Cog JIT VM only)    	48	various properties of the Cog VM as an integer encoding an array of bit flags.    		Bit 0: tells the VM that the image's Process class has threadId as its 5th inst var (after nextLink, suspendedContext, priority & myList)    		Bit 1: on Cog JIT VMs asks the VM to set the flag bit in interpreted methods    		Bit 2: if set, preempting a process puts it to the head of its run queue, not the back,    				i.e. preempting a process by a higher priority one will not cause the preempted process to yield    					to others at the same priority.    		Bit 3: in a muilt-threaded VM, if set, the Window system will only be accessed from the first VM thread    		Bit 4: in a Spur vm, if set, causes weaklings and ephemerons to be queued individually for finalization    	49	the size of the external semaphore table (read-write; Cog VMs only)    	55	ratio of growth and image size at or above which a GC will be performed post scavenge (Spur only, otherwise nil)    	67	the maximum allowed size of old space in bytes, 0 implies no internal limit (Spur only).    	68	the average number of live stack pages when scanned by GC (at scavenge/gc/become et al)    	69	the maximum number of live stack pages when scanned by GC (at scavenge/gc/become et al)    	74 maximum pause time due to segment allocation    	75 whether arithmetic primitives will do mixed type arithmetic; if false they fail for different receiver and argument types"    Below, I print and then set per Eliot's email                SmalltalkImage current vmParameterAt:25 16777216         SmalltalkImage current vmParameterAt:25 put: (2 raisedTo:30).                SmalltalkImage current vmParameterAt:45  0        SmalltalkImage current vmParameterAt:45 put:536870912.                SmalltalkImage current vmParameterAt:55   0.33333298563957214         SmalltalkImage current vmParameterAt:55 put: 0.75.<a id="org668a48a"></a>## Doits for VMParameters    Here are the examples from the SmalltalkImage>>vmParameterAt: with handy doits        SmalltalkImage current vmParameterAt:1	     "byte size of old-space (read-only)"    SmalltalkImage current vmParameterAt:2	     "byte size of young-space (read-only)"    SmalltalkImage current vmParameterAt:3	     "byte size of object memory (read-only)"    SmalltalkImage current vmParameterAt:4	     "allocationCount (read-only; nil in Cog VMs)"    SmalltalkImage current vmParameterAt:5	     "allocations between GCs (read-write; nil in Cog VMs)"    SmalltalkImage current vmParameterAt:6	     "survivor count tenuring threshold (read-write)"    SmalltalkImage current vmParameterAt:7	     "full GCs since startup (read-only)"    SmalltalkImage current vmParameterAt:8	     "total milliseconds in full GCs since startup (read-only)"    SmalltalkImage current vmParameterAt:9	     "incremental GCs since startup (read-only; scavenging GCs on Spur)"    SmalltalkImage current vmParameterAt:10	     "total milliseconds in incremental/scavenging GCs since startup (read-only)"    SmalltalkImage current vmParameterAt:11	     "tenures of surving objects since startup/last write (read-write)"    SmalltalkImage current vmParameterAt:12	     "event trace mask; if 1 << eventType is set in the mask then event received by primGetNextEvent: will be printed to stderr."    SmalltalkImage current vmParameterAt:13-15        "specific to the (o0bsolete) translating VM"    SmalltalkImage current vmParameterAt:16	     "total microseconds in idle since startup"    SmalltalkImage current vmParameterAt:17	     "proportion of code zone available for use (Sista VMs only; read-write)"    SmalltalkImage current vmParameterAt:18	     "total milliseconds in full GC compaction since startup (a portion of parameter 8)"    SmalltalkImage current vmParameterAt:19	     "scavenge threshold; the effective size of eden"    SmalltalkImage current vmParameterAt:20	     "utc microseconds at VM start-up (actually at time initialization, which precedes image load) (newer Cog VMs only)."    SmalltalkImage current vmParameterAt:21	     "root (remembered) table size (read-only)"    SmalltalkImage current vmParameterAt:22	     "root (remembered) table overflows since startup (read-only)"    SmalltalkImage current vmParameterAt:23	     "bytes of extra memory to reserve for VM buffers, plugins, etc."    SmalltalkImage current vmParameterAt:24	     "memory threshold above which to shrink object memory (read-write)"    SmalltalkImage current vmParameterAt:25	     "ammount to grow by when growing object memory (read-write)"    SmalltalkImage current vmParameterAt:26	     "interruptChecksEveryNms - force an ioProcessEvents every N milliseconds (read-write)"    SmalltalkImage current vmParameterAt:27	     "number of times mark loop iterated for current IGC/FGC (read-only) includes ALL marking"    SmalltalkImage current vmParameterAt:28	     "number of times sweep loop iterated for current IGC/FGC (read-only)"    SmalltalkImage current vmParameterAt:29	     "number of times make forward loop iterated for current IGC/FGC (read-only)"    SmalltalkImage current vmParameterAt:30	     "number of times compact move loop iterated for current IGC/FGC (read-only)"    SmalltalkImage current vmParameterAt:31	     "number of grow memory requests (read-only)"    SmalltalkImage current vmParameterAt:32	     "number of shrink memory requests (read-only)"    SmalltalkImage current vmParameterAt:33	     "number of root table entries used for current IGC/FGC (read-only)"    SmalltalkImage current vmParameterAt:34	     "bytes allocated in total since start-up or reset (read-write)"    SmalltalkImage current vmParameterAt:35	     "number of survivor objects after current IGC/FGC (read-only)"    SmalltalkImage current vmParameterAt:36	     "millisecond clock when current IGC/FGC completed (read-only)"    SmalltalkImage current vmParameterAt:37	     "number of marked objects for Roots of the world, not including Root Table entries for current IGC/FGC (read-only)"    SmalltalkImage current vmParameterAt:38	     "milliseconds taken by current IGC (read-only)"    SmalltalkImage current vmParameterAt:39	     "Number of finalization signals for Weak Objects pending when current IGC/FGC completed (read-only)"    SmalltalkImage current vmParameterAt:40	     "BytesPerWord for this image"    SmalltalkImage current vmParameterAt:41	     "imageFormatVersion for the VM"    SmalltalkImage current vmParameterAt:42	     "number of stack pages in use (Cog Stack VM only, otherwise nil)"    SmalltalkImage current vmParameterAt:43	     "desired number of stack pages (stored in image file header, max 65535; Cog VMs only, otherwise nil)"    SmalltalkImage current vmParameterAt:44	     "size of eden, in bytes (Cog VMs only, otherwise nil)"    SmalltalkImage current vmParameterAt:45	     "desired size of eden, in bytes (stored in image file header; Cog VMs only, otherwise nil)"    SmalltalkImage current vmParameterAt:46	     "size of machine code zone, in bytes (stored in image file header; Cog JIT VM only, otherwise nil)"    SmalltalkImage current vmParameterAt:47	     "desired size of machine code zone, in bytes (applies at startup only, stored in image file header; Cog JIT VM only)"    SmalltalkImage current vmParameterAt:48	     "various properties stored in the image header (that instruct the VM) as an integer encoding an array of bit flags."    												Bit 0: tells the VM that the image's Process class has threadId as its 5th inst var (after nextLink, suspendedContext, priority & myList)    												Bit 1: on Cog JIT VMs asks the VM to set the flag bit in interpreted methods    												Bit 2: if set, preempting a process puts it to the head of its run queue, not the back,    													i.e. preempting a process by a higher priority one will not cause the preempted process to yield    													to others at the same priority.    												Bit 3: in a muilt-threaded VM, if set, the Window system will only be accessed from the first VM thread    												Bit 4: in a Spur vm, if set, causes weaklings and ephemerons to be queued individually for finalization    												Bit 5: if set, implies wheel events will be delivered as such and not mapped to arrow key events    												Bit 6: if set, implies arithmetic primitives will fail if given arguments of different types (float vs int)"    SmalltalkImage current vmParameterAt:49	     "the size of the external semaphore table (read-write; Cog VMs only)"    SmalltalkImage current vmParameterAt:50-51   "reserved for VM parameters that persist in the image (such as eden above)"    SmalltalkImage current vmParameterAt:52	      "root (remembered) table maximum size (read-only)"    SmalltalkImage current vmParameterAt:53	     "the number of oldSpace segments (Spur only, otherwise nil)"    SmalltalkImage current vmParameterAt:54	     "total size of free old space (Spur only, otherwise nil)"    SmalltalkImage current vmParameterAt:55	     "ratio of growth and image size at or above which a GC will be performed post scavenge (Spur only, otherwise nil)"    SmalltalkImage current vmParameterAt:56	     "number of process switches since startup (read-only)"    SmalltalkImage current vmParameterAt:57	     "number of ioProcessEvents calls since startup (read-only)"    SmalltalkImage current vmParameterAt:58	     "number of forceInterruptCheck (Cog VMs) or quickCheckInterruptCalls (non-Cog VMs) calls since startup (read-only)"    SmalltalkImage current vmParameterAt:59	     "number of check event calls since startup (read-only)"    SmalltalkImage current vmParameterAt:60	     "number of stack page overflows since startup (read-only; Cog VMs only)"    SmalltalkImage current vmParameterAt:61	     "number of stack page divorces since startup (read-only; Cog VMs only)"    SmalltalkImage current vmParameterAt:62	     "number of machine code zone compactions since startup (read-only; Cog VMs only)"    SmalltalkImage current vmParameterAt:63	     "milliseconds taken by machine code zone compactions since startup (read-only; Cog VMs only)"    SmalltalkImage current vmParameterAt:64	     "current number of machine code methods (read-only; Cog VMs only)"    SmalltalkImage current vmParameterAt:65	     "In newer Cog VMs a set of flags describing VM features,"    											     if non-zero bit 0 implies multiple bytecode set support;    											     if non-zero bit 1 implies read-only object support;    											     if non-zero bit 2 implies the VM suffers from using an ITIMER heartbeat (if 0 it has a thread that provides the heartbeat)    												(read-only; Cog VMs only; nil in older Cog VMs, a boolean answering multiple bytecode support in not so old Cog VMs)"            SmalltalkImage current vmParameterAt:66	     "the byte size of a stack page in the stack zone  (read-only; Cog VMs only)"    SmalltalkImage current vmParameterAt:67	     "the maximum allowed size of old space in bytes, 0 implies no internal limit (Spur VMs only)."    SmalltalkImage current vmParameterAt:68	     "the average number of live stack pages when scanned by GC (at scavenge/gc/become et al)"    SmalltalkImage current vmParameterAt:69	     "the maximum number of live stack pages when scanned by GC (at scavenge/gc/become et al)"    SmalltalkImage current vmParameterAt:70	     "the value of VM_PROXY_MAJOR (the interpreterProxy major version number)"    SmalltalkImage current vmParameterAt:71	     "the value of VM_PROXY_MINOR (the interpreterProxy minor version number)"    SmalltalkImage current vmParameterAt:72           "total milliseconds in full GCs Mark phase since startup (read-only)"    SmalltalkImage current vmParameterAt:73           "total milliseconds in full GCs Sweep phase since startup (read-only, can be 0 depending on compactors)"    SmalltalkImage current vmParameterAt:74           "maximum pause time due to segment allocation"    SmalltalkImage current vmParameterAt:75           "whether arithmetic primitives will do mixed type arithmetic; if false they fail for different receiver and argument types"<a id="org089e6f9"></a>## Rebuild the VM    ? That is an open question at the moment.        Here is the pristine image size immediately after setting the parameters above        bash-4.3$ ls -lh shared/Squeak6.0alpha-20582-64bit.image     -rw-r--r-- 1 wm users 77M Oct 17 14:03 shared/Squeak6.0alpha-20582-64bit.image